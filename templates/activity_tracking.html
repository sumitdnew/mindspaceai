<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Tracking - MindSpace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FF9800;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
        }

        .activity-summary {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary-color);
        }

        .activity-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            text-align: center;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .detail-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .prediction-comparison {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--secondary-color);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .comparison-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .comparison-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .predicted-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .actual-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .accuracy-indicator {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .accuracy-high {
            background: #d4edda;
            color: #155724;
        }

        .accuracy-medium {
            background: #fff3cd;
            color: #856404;
        }

        .accuracy-low {
            background: #f8d7da;
            color: #721c24;
        }

        .rating-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .rating-group {
            margin-bottom: 25px;
        }

        .rating-label {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--dark-bg);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rating-slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 10px;
        }

        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .rating-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .rating-scale {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .rating-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-top: 10px;
        }

        .energy-impact {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .energy-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
            transition: width 0.3s ease;
            border-radius: 15px;
        }

        .energy-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .avoidance-section {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--warning-color);
        }

        .avoidance-reasons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .avoidance-reason {
            background: white;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avoidance-reason:hover {
            background: #ffeaa7;
            border-color: var(--warning-color);
        }

        .avoidance-reason.selected {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .btn-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .btn-secondary-custom {
            background: var(--light-bg);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .btn-secondary-custom:hover {
            background: var(--primary-color);
            color: white;
        }

        .celebration-animation {
            animation: celebrate 0.6s ease-in-out;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .insights-section {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--success-color);
        }

        .insight-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .insight-icon {
            color: var(--success-color);
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                🧠 MindSpace ML
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('phq9_assessment') }}">📋 PHQ-9 Assessment</a>
                <a class="nav-link" href="{{ url_for('journal') }}">📖 Journal</a>
                <a class="nav-link" href="{{ url_for('mood_tracking.mood_tracker') }}">😊 Mood</a>
                <a class="nav-link" href="{{ url_for('mindfulness_exercises.mindfulness_dashboard') }}">🧘 Mindfulness</a>
                <a class="nav-link" href="{{ url_for('thought_record_dashboard') }}">🔍 Thought Detective</a>
                <a class="nav-link active" href="{{ url_for('behavioral_activation_dashboard') }}">🚀 Activities</a>
                <a class="nav-link" href="{{ url_for('goals') }}">🎯 Goals</a>
                <a class="nav-link" href="{{ url_for('insights') }}">📈 Insights</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Header Section -->
        <div class="header-section">
            <h1><i class="fas fa-check-circle"></i> Activity Completion</h1>
            <p class="mb-0">Track how this activity affected your mood and energy</p>
        </div>

        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('patient_dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('behavioral_activation_dashboard') }}">Activities</a></li>
                <li class="breadcrumb-item active" aria-current="page">Track Activity</li>
            </ol>
        </nav>

        <!-- Activity Summary -->
        <div class="activity-summary">
            <h4><i class="fas fa-info-circle"></i> Activity Details</h4>
            <div class="activity-details">
                <div class="detail-item">
                    <div class="detail-label">Activity</div>
                    <div class="detail-value">{{ activity.activity.name }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Category</div>
                    <div class="detail-value">{{ activity.activity.category.name }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Duration</div>
                    <div class="detail-value">{{ activity.duration_planned }} min</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Scheduled Date</div>
                    <div class="detail-value">{{ activity.scheduled_date.strftime('%b %d, %Y') }}</div>
                </div>
            </div>
        </div>

        <!-- Prediction Comparison -->
        {% if activity.predicted_enjoyment %}
        <div class="prediction-comparison">
            <h4><i class="fas fa-chart-line"></i> Prediction vs. Reality</h4>
            <p>Compare your predictions with how the activity actually went.</p>
            
            <div class="comparison-grid">
                <div class="comparison-item">
                    <div class="comparison-label">Enjoyment</div>
                    <div class="predicted-value">{{ activity.predicted_enjoyment }}/10</div>
                    <div class="actual-value" id="actualEnjoyment">-</div>
                    <div class="accuracy-indicator" id="enjoymentAccuracy">-</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-label">Energy Cost</div>
                    <div class="predicted-value">{{ activity.predicted_energy_cost }}/10</div>
                    <div class="actual-value" id="actualEnergyCost">-</div>
                    <div class="accuracy-indicator" id="energyAccuracy">-</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-label">Mood Boost</div>
                    <div class="predicted-value">{{ activity.predicted_mood_boost }}/10</div>
                    <div class="actual-value" id="actualMoodBoost">-</div>
                    <div class="accuracy-indicator" id="moodAccuracy">-</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Rating Section -->
        <form method="POST" id="trackingForm">
            <div class="rating-section">
                <h4><i class="fas fa-star"></i> How was this activity?</h4>
                
                <div class="rating-group">
                    <div class="rating-label">
                        <span>Enjoyment Level</span>
                        <span class="rating-value" id="enjoymentValue">5</span>
                    </div>
                    <input type="range" class="rating-slider" id="enjoymentSlider" name="actual_enjoyment" 
                           min="1" max="10" value="5" oninput="updateRating('enjoyment')">
                    <div class="rating-scale">
                        <span>Not enjoyable</span>
                        <span>Very enjoyable</span>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">
                        <span>Energy Cost</span>
                        <span class="rating-value" id="energyCostValue">5</span>
                    </div>
                    <input type="range" class="rating-slider" id="energyCostSlider" name="actual_energy_cost" 
                           min="1" max="10" value="5" oninput="updateRating('energyCost')">
                    <div class="rating-scale">
                        <span>Very low energy</span>
                        <span>Very high energy</span>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">
                        <span>Mood Boost</span>
                        <span class="rating-value" id="moodBoostValue">5</span>
                    </div>
                    <input type="range" class="rating-slider" id="moodBoostSlider" name="actual_mood_boost" 
                           min="1" max="10" value="5" oninput="updateRating('moodBoost')">
                    <div class="rating-scale">
                        <span>No mood boost</span>
                        <span>Major mood boost</span>
                    </div>
                </div>

                <div class="rating-group">
                    <div class="rating-label">
                        <span>Energy After Activity</span>
                        <span class="rating-value" id="energyAfterValue">5</span>
                    </div>
                    <input type="range" class="rating-slider" id="energyAfterSlider" name="actual_energy_after" 
                           min="1" max="10" value="5" oninput="updateRating('energyAfter')">
                    <div class="rating-scale">
                        <span>Exhausted</span>
                        <span>Energized</span>
                    </div>
                </div>
            </div>

            <!-- Energy Impact Visualization -->
            <div class="energy-impact">
                <h4><i class="fas fa-battery-half"></i> Energy Impact</h4>
                <p>Visualize how this activity affected your energy levels.</p>
                
                <div class="energy-bar">
                    <div class="energy-fill" id="energyFill" style="width: 50%"></div>
                </div>
                <div class="energy-labels">
                    <span>Before: <span id="energyBefore">5</span>/10</span>
                    <span>After: <span id="energyAfter">5</span>/10</span>
                </div>
            </div>

            <!-- Avoidance Tracking -->
            <div class="avoidance-section">
                <h4><i class="fas fa-exclamation-triangle"></i> Did you avoid this activity?</h4>
                <p>If you didn't complete this activity, let us know why to help improve future planning.</p>
                
                <div class="avoidance-reasons">
                    <div class="avoidance-reason" data-reason="low_energy">Low Energy</div>
                    <div class="avoidance-reason" data-reason="bad_mood">Bad Mood</div>
                    <div class="avoidance-reason" data-reason="weather">Weather</div>
                    <div class="avoidance-reason" data-reason="time_constraint">No Time</div>
                    <div class="avoidance-reason" data-reason="social_anxiety">Social Anxiety</div>
                    <div class="avoidance-reason" data-reason="other">Other</div>
                </div>
                
                <input type="hidden" name="avoidance_reason" id="avoidanceReason">
            </div>

            <!-- Action Buttons -->
            <div class="text-center">
                <button type="submit" class="btn btn-custom me-3">
                    <i class="fas fa-save"></i> Save & Continue
                </button>
                <a href="{{ url_for('behavioral_activation_dashboard') }}" class="btn btn-secondary-custom">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </form>

        <!-- Insights Section -->
        <div class="insights-section" id="insightsSection" style="display: none;">
            <h4><i class="fas fa-lightbulb"></i> Activity Insights</h4>
            <div id="insightsContent">
                <!-- Insights will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update rating values
        function updateRating(type) {
            const slider = document.getElementById(type + 'Slider');
            const value = slider.value;
            document.getElementById(type + 'Value').textContent = value;
            
            // Update energy impact visualization
            if (type === 'energyAfter') {
                updateEnergyImpact();
            }
            
            // Update prediction comparison if available
            updatePredictionComparison();
        }

        // Update energy impact visualization
        function updateEnergyImpact() {
            const energyCost = parseInt(document.getElementById('energyCostSlider').value);
            const energyAfter = parseInt(document.getElementById('energyAfterSlider').value);
            
            // Calculate energy before (simplified - would be more sophisticated in real app)
            const energyBefore = Math.max(1, energyAfter + energyCost - 5);
            
            document.getElementById('energyBefore').textContent = energyBefore;
            document.getElementById('energyAfter').textContent = energyAfter;
            
            // Update energy bar
            const energyFill = document.getElementById('energyFill');
            const energyChange = ((energyAfter - energyBefore) / 9) * 100 + 50; // Normalize to 0-100%
            energyFill.style.width = Math.max(0, Math.min(100, energyChange)) + '%';
        }

        // Update prediction comparison
        function updatePredictionComparison() {
            const predictedEnjoyment = {{ activity.predicted_enjoyment or 5 }};
            const predictedEnergyCost = {{ activity.predicted_energy_cost or 5 }};
            const predictedMoodBoost = {{ activity.predicted_mood_boost or 5 }};
            
            const actualEnjoyment = parseInt(document.getElementById('enjoymentSlider').value);
            const actualEnergyCost = parseInt(document.getElementById('energyCostSlider').value);
            const actualMoodBoost = parseInt(document.getElementById('moodBoostSlider').value);
            
            // Update actual values
            document.getElementById('actualEnjoyment').textContent = actualEnjoyment + '/10';
            document.getElementById('actualEnergyCost').textContent = actualEnergyCost + '/10';
            document.getElementById('actualMoodBoost').textContent = actualMoodBoost + '/10';
            
            // Calculate accuracy
            const enjoymentAccuracy = Math.abs(predictedEnjoyment - actualEnjoyment);
            const energyAccuracy = Math.abs(predictedEnergyCost - actualEnergyCost);
            const moodAccuracy = Math.abs(predictedMoodBoost - actualMoodBoost);
            
            // Update accuracy indicators
            updateAccuracyIndicator('enjoymentAccuracy', enjoymentAccuracy);
            updateAccuracyIndicator('energyAccuracy', energyAccuracy);
            updateAccuracyIndicator('moodAccuracy', moodAccuracy);
        }

        // Update accuracy indicator
        function updateAccuracyIndicator(elementId, accuracy) {
            const element = document.getElementById(elementId);
            let text, className;
            
            if (accuracy <= 1) {
                text = 'Excellent';
                className = 'accuracy-high';
            } else if (accuracy <= 3) {
                text = 'Good';
                className = 'accuracy-medium';
            } else {
                text = 'Needs Work';
                className = 'accuracy-low';
            }
            
            element.textContent = text;
            element.className = 'accuracy-indicator ' + className;
        }

        // Handle avoidance reasons
        document.querySelectorAll('.avoidance-reason').forEach(reason => {
            reason.addEventListener('click', function() {
                // Remove selection from other reasons
                document.querySelectorAll('.avoidance-reason').forEach(r => r.classList.remove('selected'));
                // Select this reason
                this.classList.add('selected');
                document.getElementById('avoidanceReason').value = this.dataset.reason;
            });
        });

        // Form submission
        document.getElementById('trackingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show celebration animation
            document.querySelector('.header-section').classList.add('celebration-animation');
            
            // Generate insights
            generateInsights();
            
            // Submit form
            this.submit();
        });

        // Generate insights based on ratings
        function generateInsights() {
            const enjoyment = parseInt(document.getElementById('enjoymentSlider').value);
            const energyCost = parseInt(document.getElementById('energyCostSlider').value);
            const moodBoost = parseInt(document.getElementById('moodBoostSlider').value);
            const energyAfter = parseInt(document.getElementById('energyAfterSlider').value);
            
            const insights = [];
            
            if (enjoyment >= 8) {
                insights.push({
                    icon: 'fas fa-star',
                    text: 'Great job! You really enjoyed this activity. Consider adding similar activities to your routine.'
                });
            } else if (enjoyment <= 3) {
                insights.push({
                    icon: 'fas fa-exclamation-triangle',
                    text: 'This activity wasn\'t enjoyable. Let\'s find alternatives that better match your preferences.'
                });
            }
            
            if (moodBoost >= 7) {
                insights.push({
                    icon: 'fas fa-smile',
                    text: 'Excellent mood boost! This activity is great for improving your mental state.'
                });
            }
            
            if (energyAfter > energyCost) {
                insights.push({
                    icon: 'fas fa-battery-full',
                    text: 'This activity actually gave you energy! It\'s a great energizing activity.'
                });
            } else if (energyAfter < 3) {
                insights.push({
                    icon: 'fas fa-battery-empty',
                    text: 'This activity was quite draining. Consider scheduling it when you have more energy.'
                });
            }
            
            // Display insights
            const insightsSection = document.getElementById('insightsSection');
            const insightsContent = document.getElementById('insightsContent');
            
            if (insights.length > 0) {
                insightsContent.innerHTML = insights.map(insight => `
                    <div class="insight-item">
                        <i class="${insight.icon} insight-icon"></i>
                        ${insight.text}
                    </div>
                `).join('');
                insightsSection.style.display = 'block';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateEnergyImpact();
            updatePredictionComparison();
        });
    </script>
</body>
</html>
