<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Briefing Test - MindSpace ML</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .test-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .status-success { border-left: 5px solid #28a745; background-color: #f8fff8; }
        .status-error { border-left: 5px solid #dc3545; background-color: #fff5f5; }
        .status-loading { border-left: 5px solid #ffc107; background-color: #fffbf0; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain"></i> MindSpace ML - AI Briefing Test
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/provider/comprehensive_dashboard">
                    <i class="fas fa-chart-line"></i> Comprehensive Dashboard
                </a>
                <a class="nav-link" href="/provider_dashboard_basic">
                    <i class="fas fa-tachometer-alt"></i> Basic Dashboard
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="test-card">
            <h2><i class="fas fa-robot"></i> AI Briefing System Test</h2>
            <p class="text-muted">Test the AI briefing generation functionality</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="patientSelect" class="form-label">Select Patient</label>
                        <select class="form-select" id="patientSelect">
                            <option value="">Choose a patient...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Actions</label>
                        <div>
                            <button class="btn btn-primary" onclick="testBriefing()" id="testBtn">
                                <i class="fas fa-play"></i> Test AI Briefing
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearResults()">
                                <i class="fas fa-trash"></i> Clear Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-card" id="resultsCard" style="display: none;">
            <h4><i class="fas fa-chart-line"></i> Test Results</h4>
            <div id="testResults">
                <!-- Results will be populated here -->
            </div>
        </div>

        <div class="test-card" id="briefingCard" style="display: none;">
            <h4><i class="fas fa-file-alt"></i> Generated Briefing</h4>
            <div id="briefingContent">
                <!-- Briefing content will be populated here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let patients = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
        });

        async function loadPatients() {
            try {
                const response = await fetch('/provider/api/dashboard/system_metrics');
                const data = await response.json();
                
                if (data.patients) {
                    patients = data.patients;
                    populatePatientSelect();
                }
            } catch (error) {
                console.error('Error loading patients:', error);
                showError('Failed to load patients: ' + error.message);
            }
        }

        function populatePatientSelect() {
            const select = document.getElementById('patientSelect');
            select.innerHTML = '<option value="">Choose a patient...</option>';
            
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.patient_id;
                option.textContent = patient.patient_name;
                select.appendChild(option);
            });
        }

        async function testBriefing() {
            const patientId = document.getElementById('patientSelect').value;
            if (!patientId) {
                showError('Please select a patient first');
                return;
            }

            const testBtn = document.getElementById('testBtn');
            const resultsCard = document.getElementById('resultsCard');
            const briefingCard = document.getElementById('briefingCard');
            
            // Show loading state
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            testBtn.disabled = true;
            
            resultsCard.style.display = 'block';
            briefingCard.style.display = 'none';
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> Testing AI briefing generation...
                </div>
            `;

            try {
                const startTime = Date.now();
                const response = await fetch(`/provider/api/session_briefing/${patientId}`);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data, duration);
                    showBriefing(data);
                } else {
                    showError(data.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error testing briefing:', error);
                showError('Network error: ' + error.message);
            } finally {
                testBtn.innerHTML = '<i class="fas fa-play"></i> Test AI Briefing';
                testBtn.disabled = false;
            }
        }

        function showSuccess(data, duration) {
            const resultsCard = document.getElementById('resultsCard');
            resultsCard.className = 'test-card status-success';
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Test Successful!</strong>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Test Details</h6>
                        <ul class="list-unstyled">
                            <li><strong>Patient:</strong> ${data.patient_name}</li>
                            <li><strong>Response Time:</strong> ${duration}ms</li>
                            <li><strong>Success:</strong> ${data.success}</li>
                            <li><strong>Mock Data:</strong> ${data.is_mock ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Data Summary</h6>
                        <ul class="list-unstyled">
                            <li><strong>Mood Entries:</strong> ${data.data_summary?.mood_entries_count || 0}</li>
                            <li><strong>Exercise Sessions:</strong> ${data.data_summary?.exercise_sessions_count || 0}</li>
                            <li><strong>Thought Records:</strong> ${data.data_summary?.thought_records_count || 0}</li>
                            <li><strong>PHQ-9 Assessments:</strong> ${data.data_summary?.phq9_assessments_count || 0}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function showError(errorMessage) {
            const resultsCard = document.getElementById('resultsCard');
            resultsCard.className = 'test-card status-error';
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Test Failed!</strong><br>
                    Error: ${errorMessage}
                </div>
            `;
        }

        function showBriefing(data) {
            const briefingCard = document.getElementById('briefingCard');
            briefingCard.style.display = 'block';
            
            let html = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> AI Briefing generated for <strong>${data.patient_name}</strong>
                    <br><small>Generated at: ${new Date(data.generated_at).toLocaleString()}</small>
                </div>
            `;

            if (data.key_insights && data.key_insights.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Key Insights</h6>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                ${data.key_insights.map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }

            if (data.recommendations && data.recommendations.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-target"></i> Recommendations</h6>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }

            if (data.briefing_text) {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-file-alt"></i> Full Briefing</h6>
                        </div>
                        <div class="card-body">
                            <div style="white-space: pre-line; max-height: 400px; overflow-y: auto;">${data.briefing_text}</div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('briefingContent').innerHTML = html;
        }

        function clearResults() {
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('briefingCard').style.display = 'none';
            document.getElementById('patientSelect').value = '';
        }
    </script>
</body>
</html>
